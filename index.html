<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Trabajo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding-top: 6vh;
      min-height: 100vh;
    }
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .site-title {
      text-align: center;
      color: #2563eb;
      font-size: 2.2rem;
      font-weight: 800;
      margin-bottom: 20px;
      line-height: 1.05;
      letter-spacing: 0.6px;
      text-shadow: 0 3px 8px rgba(255,255,255,0.95);
    }
    h2 { text-align: center; }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #1d4ed8; }
    .hidden { display: none; }
  </style>
</head>
<body>


<script>
  function guardar() {
  if (!navigator.geolocation) {
    alert("geolocalizacion no disponible");
    return;
  }

  navigator.geolocation.getCurrentPosition((position) => {
    const datos = {
      usuario: "Jair",
      latitud: position.coords.latitude,
      longitud: position.coords.longitude,
      fecha: new Date().toLocaleString()
    };

    fetch("/guardar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(datos)
    })
    .then(res => res.text())
    .then(msg => alert(msg))
    .catch(() => alert("Error al guardar los datos"));
  }, () => {
        alert("No se pudo obtener la ubicación"));
  }
</script>
  <!-- LOGIN -->
  <div class="site-title">Entrega Eficiente</div>
  <div class="card" id="login">
    <h2>Iniciar sesión</h2>
    <input type="text" id="user" placeholder="Usuario">
    <input type="password" id="pass" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
  </div>

  <!-- FORMULARIO -->
  <div class="card hidden" id="formulario">
    <h2>Registro Diario</h2>
    <label>Hora de entrada</label>
    <input type="time" id="entrada">

    <label>Hora de salida</label>
    <input type="time" id="salida">

    <label>Cantidad de trabajo del día</label>
    <input type="number" id="trabajo" placeholder="Ej: 15">

    <button onclick="guardar()">Guardar</button>
    <button onclick="logout()">Cerrar sesión</button>
    <button onclick="verRegistros()">Ver registros</button>

    <div class="hidden" id="registrosContainer" style="margin-top:12px;">
      <h3 style="margin:0 0 8px 0; text-align:center">Registros</h3>
      <div id="registros"></div>
      <button style="margin-top:8px;" onclick="closeRegistros()">Cerrar registros</button>
    </div>
  </div>

<script>
  // URL para Google Sheets
  const URL_SHEETS = "https://script.google.com/macros/s/AKfycbzYEX5yTFf2-TmNGEeUpGLsASk_mkkze0BMHIFCle_a20_L8T-abIShOvDgmJzqwYiY/exec";

  // USUARIOS DE PRUEBA
  const usuarios = {
    "Jair": "12345",
    "Alexander": "12345",
    "Saul": "12345"
  };

  function login() {
    const u = document.getElementById('user').value;
    const p = document.getElementById('pass').value;

    if (usuarios[u] === p) {
      localStorage.setItem('usuario', u);
      document.getElementById('login').classList.add('hidden');
      document.getElementById('formulario').classList.remove('hidden');
    } else {
      alert("Usuario o contraseña incorrectos");
    }
  }

  function guardar() {
    navigator.geolocation.getCurrentPosition(pos => {
      const data = {
        usuario: localStorage.getItem('usuario'),
        entrada: document.getElementById('entrada').value,
        salida: document.getElementById('salida').value,
        trabajo: document.getElementById('trabajo').value,
        fecha: new Date().toLocaleString(),
        latitud: pos.coords.latitude,
        longitud: pos.coords.longitude
      };

      fetch(URL_SHEETS, {
        method: "POST",
        body: JSON.stringify(data)
      })
      .then(() => alert("Registro enviado correctamente"))
      .catch(() => alert("Error al enviar"));

      let registros = JSON.parse(localStorage.getItem('registros')) || [];
      registros.push(data);
      localStorage.setItem('registros', JSON.stringify(registros));
    }, () => {
      alert('No se pudo obtener la ubicación');
    });
  }

  function logout() {
    localStorage.removeItem('usuario');
    location.reload();
  }

  function verRegistros() {
    fetch(URL_SHEETS)
      .then(res => {
        if (!res.ok) {
          return res.text().then(text => { throw new Error('HTTP ' + res.status + ' - ' + text); });
        }
        const ct = res.headers.get('content-type') || '';
        if (ct.indexOf('application/json') === -1) {
          return res.text().then(text => {
            try { return JSON.parse(text); }
            catch (e) { throw new Error('Respuesta no JSON: ' + text); }
          });
        }
        return res.json();
      })
      .then(data => {
        if (data.error) throw new Error(data.error);
        if (!data || data.length === 0) return alert('No hay registros');

        const container = document.getElementById('registros');
        const keys = Object.keys(data[0]);
        let html = '<table style="width:100%;border-collapse:collapse">';
        html += '<thead><tr>';
        keys.forEach(k => { html += '<th style="border:1px solid #ddd;padding:6px;background:#f3f4f6;text-align:left">' + k + '</th>'; });
        html += '</tr></thead><tbody>';
        data.forEach(row => {
          html += '<tr>';
          keys.forEach(k => { html += '<td style="border:1px solid #ddd;padding:6px">' + (row[k] || '') + '</td>'; });
          html += '</tr>';
        });
        html += '</tbody></table>';
        container.innerHTML = html;
        document.getElementById('registrosContainer').classList.remove('hidden');
      })
      .catch(err => {
        console.error('verRegistros error:', err);
        const container = document.getElementById('registros');
        container.innerHTML = '<pre style="white-space:pre-wrap;color:#b91c1c;">' + String(err) + '</pre>';
        document.getElementById('registrosContainer').classList.remove('hidden');
        alert('Error al obtener registros: ' + err);
      });
  }

  function closeRegistros() {
    document.getElementById('registrosContainer').classList.add('hidden');
  }
</script>

</body>
</html>
